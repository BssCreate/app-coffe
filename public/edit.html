<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é</title>
    <style>

        * {
            -webkit-tap-highlight-color: transparent; /* –£–±–∏—Ä–∞–µ–º —Å–∏–Ω–∏–π —Ñ–æ–Ω –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
        }

        /* 3. –û—Ç–∫–ª—é—á–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–∏ –¥–æ–ª–≥–æ–º –Ω–∞–∂–∞—Ç–∏–∏ */
        * {
            user-select: none;          /* –û—Ç–∫–ª—é—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
            -webkit-user-select: none;  /* –î–ª—è Safari */
            -ms-user-select: none;      /* –î–ª—è —Å—Ç–∞—Ä—ã—Ö IE */
            -moz-user-select: none;     /* –î–ª—è Firefox */
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        img {
            pointer-events: none;       /* –û—Ç–∫–ª—é—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –º—ã—à–∏ */
            -webkit-user-drag: none;    /* –û—Ç–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        }

        /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { display: flex; height: 100vh; font-family: Arial, sans-serif; }
        .sidebar { width: 20%; background-color: #f4f4f4; padding: 20px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); }
        .sidebar ul { list-style: none; }
        .sidebar li { padding: 10px; margin-bottom: 10px; background-color: #fff; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .dish { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        .buttons { display: flex; gap: 10px; }
        .button { padding: 10px 20px; background-color: #007bff; color: #fff; border-radius: 5px; cursor: pointer; }
        .button.delete { background-color: #ff4d4d; }
        .add-btn { padding: 15px 30px; background-color: #28a745; color: #fff; border-radius: 5px; margin-top: 20px; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 400px; }
        .modal-content h2 { margin-bottom: 10px; }
        .modal-content input, textarea { width: 100%; padding: 10px; margin: 10px 0; }
        .modal-content button { padding: 10px 20px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
        <ul id="categories"></ul>
        <button class="add-btn" onclick="openCategoryModal()">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
    </div>
    <div class="content" id="content">
        <h1 id="category-title"></h1>
        <div id="dishes"></div>
        <button class="add-btn" onclick="openNewDishModal()">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
            <input type="text" id="category-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
            <button onclick="saveCategory()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeModal('category-modal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="modal" id="dish-modal">
        <div class="modal-content">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ</h2> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            <input type="text" id="dish-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞">
            <textarea id="dish-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
            <input type="text" id="dish-weight" placeholder="–í–µ—Å">
            <input type="text" id="dish-price" placeholder="–¶–µ–Ω–∞">
            <input type="file" id="dish-image" accept="image/*">
            <button onclick="saveDish()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeModal('dish-modal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>


    <script>
        let foodsData = {};
        let currentCategory = '';
        let currentDishIndex = null;

        async function fetchFoods() {
            const response = await fetch('/foods.json');
            foodsData = await response.json();
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            renderCategories();
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const categories = Object.keys(foodsData);
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é
            if (categories.length > 0) {
                renderDishes(categories[0]); // –ü–µ—Ä–µ–¥–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            }
        }


        function renderCategories() {
            const categoriesList = document.getElementById('categories');
            categoriesList.innerHTML = Object.keys(foodsData).map(cat => 
                `<li onclick="renderDishes('${cat}')" id="category-${cat}" class="${cat === currentCategory ? 'active' : ''}">
                    <span>${cat}</span>
                    <button class="button" onclick="openCategoryModal('${cat}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="button delete" onclick="deleteCategory('${cat}')">–£–¥–∞–ª–∏—Ç—å</button>
                </li>`
            ).join('');
        }

        function renderDishes(category) {
            currentCategory = category;
            
            // –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
            const allCategoryItems = document.querySelectorAll('.sidebar li');
            allCategoryItems.forEach(item => item.classList.remove('active'));
            document.getElementById(`category-${category}`).classList.add('active');
            
            const dishes = foodsData[category] || [];
            const dishesContainer = document.getElementById('dishes');
            document.getElementById('category-title').textContent = category;

            dishesContainer.innerHTML = dishes.map((dish, index) => ` 
                <div class="dish">
                    <div>
                        <strong>${dish.name}</strong><br>
                        ${dish.description !== 'none' ? dish.description + "<br>" : ''}
                        <small>${dish.weight} ‚Ä¢ ${dish.price}</small><br>
                        <img src="${dish.image}" alt="${dish.name}" width="100">
                    </div>
                    <div class="buttons">
                        <button class="button" onclick="openDishModal(${index})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="button delete" onclick="deleteDish(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–ª—é–¥–∞
        function openNewDishModal() {
            currentDishIndex = null;  // –ù–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –±–ª—é–¥–∞ ‚Äî —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ

            // –ò–∑–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ "–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ"
            document.querySelector('#dish-modal h2').textContent = '–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ';

            // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è
            document.getElementById('dish-name').value = '';
            document.getElementById('dish-description').value = '';
            document.getElementById('dish-weight').value = '';
            document.getElementById('dish-price').value = '';
            document.getElementById('dish-image').value = '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('dish-modal').classList.add('active');
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–ª—é–¥–∞
        function openDishModal(index) {
            currentDishIndex = index;

            const dish = foodsData[currentCategory] && foodsData[currentCategory][index];
            if (!dish) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –±–ª—é–¥–æ –ø–æ —ç—Ç–æ–º—É –∏–Ω–¥–µ–∫—Å—É!");
                return;
            }

            // –ò–∑–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ"
            document.querySelector('#dish-modal h2').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ';

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¥–∞–Ω–Ω—ã–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–ª—é–¥–∞
            document.getElementById('dish-name').value = dish.name;
            document.getElementById('dish-description').value = dish.description !== 'none' ? dish.description : '';
            document.getElementById('dish-weight').value = dish.weight;
            document.getElementById('dish-price').value = dish.price;
            document.getElementById('dish-image').value = '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('dish-modal').classList.add('active');
        }

        function saveDish() {
            const name = document.getElementById('dish-name').value.trim();
            const description = document.getElementById('dish-description').value.trim() || 'none';
            const weight = document.getElementById('dish-weight').value.trim();
            const price = document.getElementById('dish-price').value.trim();
            const imageInput = document.getElementById('dish-image');
            
            // –†–∞–∑–º–µ—Ä –∏ –±–æ—Ä—Ç–∏–∫ –≤—Å–µ–≥–¥–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
            const size = 30; // 30 —Å–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const crust = "no"; // –ù–µ—Ç –±–æ—Ä—Ç–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            
            if (!name || !weight || !price) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–ù–∞–∑–≤–∞–Ω–∏–µ, –í–µ—Å, –¶–µ–Ω–∞)');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –Ω–æ–≤–æ–≥–æ –±–ª—é–¥–∞
            const newDish = { 
                name, 
                description, 
                weight, 
                price, 
                size, 
                crust, 
                image: '/images/noimage.png' 
            };

            // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imageData = e.target.result;
                    uploadImage(imageData, imageInput.files[0].type, newDish);
                };
                reader.readAsArrayBuffer(imageInput.files[0]); // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ ArrayBuffer
            } else {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–ª—é–¥–æ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                saveDishToCategory(newDish);
            }
        }

        function uploadImage(imageData, fileType, newDish) {
            fetch('/upload', {
                method: 'POST',
                headers: { 'Content-Type': fileType },
                body: imageData // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º "—Å—ã—Ä—ã–µ" –±–∞–π—Ç—ã
            })
            .then(response => response.json())
            .then(data => {
                if (data.imageUrl) {
                    newDish.image = data.imageUrl;
                }
                saveDishToCategory(newDish);
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            });
        }

        function saveDishToCategory(newDish) {
            if (!foodsData[currentCategory]) {
                foodsData[currentCategory] = []; // –°–æ–∑–¥–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
            }

            if (currentDishIndex !== null) {
                // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –±–ª—é–¥–æ ‚Äî –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ
                foodsData[currentCategory][currentDishIndex] = newDish;
            } else {
                // –ï—Å–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –±–ª—é–¥–æ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                foodsData[currentCategory].push(newDish);
            }

            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', foodsData);
            saveChanges();
            closeModal('dish-modal');
            renderDishes(currentCategory);
        }




        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }


        function openCategoryModal(categoryName = '') {
            currentCategory = categoryName;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            document.getElementById('category-name').value = categoryName; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('category-modal').classList.add('active');
        }

        function saveCategory() {
            const categoryName = document.getElementById('category-name').value.trim();

            if (categoryName === '') {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
            if (foodsData[categoryName] && categoryName !== currentCategory) {
                alert('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                return;
            }

            // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (categoryName !== currentCategory) {
                // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –±–ª—é–¥–∞ –≤ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                foodsData[categoryName] = foodsData[currentCategory] || [];

                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                delete foodsData[currentCategory];
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeModal('category-modal');

            // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', foodsData);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            saveChanges();
            renderCategories();
        }



        function deleteCategory(categoryName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${categoryName}"?`)) {
                delete foodsData[categoryName];
                saveChanges();
                renderCategories();
            }
        }

        function saveChanges() {
            const updatedData = foodsData;  // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', updatedData);  // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
            fetch('/update-foods', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)  // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
            })
            .then(response => response.json())
            .then(data => console.log('‚úÖ –£—Å–ø–µ—Ö:', data))
            .catch(err => console.error('üö´ –û—à–∏–±–∫–∞:', err));
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', fetchFoods);
    </script>
</body>
</html>
